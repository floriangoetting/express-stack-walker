var t={t:"action",i:"config",o:"consent",u:"context",l:"destination",g:"elb",v:"globals",p:"hook",k:"init",m:"link",h:"data-elb",q:"run",j:"user",O:"walker"};function n(t,n={}){return Object.entries(n).forEach((([e,i])=>{let o=t[e];Array.isArray(o)&&Array.isArray(i)&&(n[e]=i.reduce(((t,n)=>t.includes(n)?t:[...t,n]),[...o]))})),{...t,...n}}function e(t=6){for(var n="";n.length<t;)n+=(36*Math.random()|0).toString(36);return n}function i(t,n){return typeof t==typeof n}function o(t,n){return async function(...e){try{return await t(...e)}catch(t){return n?await n(t):void 0}}}async function r(t,e,r){const a=r||t.config.destinations,s=t.config,c=await Promise.all(Object.entries(a).map((async([r,a])=>{let c;const u=[].concat(a.queue||[]);if(a.queue=[],e&&u.push(e),!u.length)return{id:r,destination:a,skipped:!0};if(!function(t,n){let e=!0;const i=n.config.consent;if(i){e=!1;const n=t.config.consent;Object.keys(i).forEach((t=>{n[t]&&(e=!0)}))}return e}(t,a))return{id:r,destination:a,queue:u};let f=u.map((t=>(t.consent=n(s.consent,t.consent),t.globals=n(s.globals,t.globals),t.user=n(s.user,t.user),{event:t})));if(a.init&&!a.config.init){const n=await o(a.init,(n=>{s.onError&&s.onError(n,t)}))(a.config)||!1;if(i(n,{})?a.config=n:a.config.init=n,!n)return{id:r,destination:a,queue:u}}return c=(await o(a.push,(n=>(s.onError&&s.onError(n,t),{error:n,queue:void 0})))(f,a.config)||{}).error,{id:r,destination:a,queue:[],error:c}}))),u=[],f=[],l=[];for(const t of c){if(t.skipped)continue;const e=t.id,i=t.destination;t.error?l.push({id:e,destination:i,error:String(t.error)}):t.queue&&t.queue.length?(i.queue=n(i.queue,t.queue),f.push({id:e,destination:i})):u.push({id:e,destination:i})}return{successful:u,queued:f,failed:l}}function a(t={},e={}){const i=e.globalsStatic||{},o={...{allowed:!1,client:"0.0.0",consent:{},custom:{},count:0,destinations:{},globals:{},globalsStatic:i,group:"",hooks:{},queue:[],round:0,timing:0,user:{},tagging:0,source:{type:"node",id:"",previous_id:""},verbose:!1},...e,...t},r=n(i,n(e.globals||{},t.globals||{}));return{...o,globals:r,globalsStatic:i,onLog:function(t,n){!function(t,n=!1){n&&console.dir(t,{depth:4})}({message:t},n||o.verbose)}}}var s={},c={};function u(t){const n=f(t);return{elb:n.push,instance:n}}function f(t={}){const n=a(t,{client:"2.0.0",globalsStatic:t.globals}),e={config:n,push:async(...t)=>{const i={status:{ok:!1},successful:[],queued:[],failed:[]};return await o(l,(t=>(n.onError&&n.onError(t,e),i.status.error=String(t),i)))(e,...t)}};return d(e),e}var l=async(n,o,s,c)=>{const u={status:{ok:!1},successful:[],queued:[],failed:[]};i(o,"")&&(o={event:o});const{event:f,action:l}=function(n,e={}){if(!e.event)throw new Error("Event name is required");const[i,o]=e.event.split(" ");if(!i||!o)throw new Error("Event name is invalid");if(i===t.O)return{action:o};const r=n.config;++r.count;const a=e.timestamp||Date.now(),s=e.timing||Math.round((a-(e.timing||r.timing))/10)/100,c=e.group||r.group,u=e.count||r.count,f=e.source||r.source;e.source&&(e.source.id&&(f.id=e.source.id),e.source.previous_id&&(f.previous_id=e.source.previous_id));const l={event:e.event,data:e.data||{},context:e.context||{},custom:e.custom||{},globals:e.globals||r.globals,user:e.user||r.user,nested:e.nested||[],consent:e.consent||r.consent,trigger:e.trigger||"",entity:i,action:o,timestamp:a,timing:s,group:c,count:u,id:`${a}-${c}-${u}`,version:{client:r.client,tagging:r.tagging},source:f};return{event:l}}(n,o);if(l){const o=await async function(n,o,s,c){let u,f={name:o,data:s};switch(o){case t.i:f.data=function(t,n={}){if(!i(n,{}))return;return t.config=a(n,t.config),t.config}(n,s)||{};break;case t.o:u=await async function(t,n={}){if(!i(n,{}))return;let e=!1;if(Object.entries(n).forEach((([n,i])=>{const o=!!i;t.config.consent[n]=o,e=e||o})),e)return await r(t)}(n,s);break;case t.l:u=await async function(t,n={},o={}){if(!i(n,{}))return;if(!i(o,{}))return;const a=o||n.config||{init:!1},s={init:n.init,push:n.push,config:a,type:n.type};let c=a.id;if(!c)do{c=e(4)}while(t.config.destinations[c]);return t.config.destinations[c]=s,!1!==a.queue&&(s.queue=[...t.config.queue]),await r(t,void 0,{[c]:s})}(n,s,c);break;case t.q:u=d(n,s);break;case t.j:f.data=function(t,n={}){if(!i(n,{}))return;const e={};"id"in n&&(e.id=n.id);"device"in n&&(e.device=n.device);"session"in n&&(e.session=n.session);return t.config.user=e,e}(n,s)}return{command:f,result:u}}(n,l,s,c);o.result&&i(o.result,{})&&(o.result.successful&&(u.successful=o.result.successful),o.result.queued&&(u.queued=o.result.queued),o.result.failed&&(u.failed=o.result.failed)),u.command=o.command,u.status.ok=!0}if(f){n.config.queue.push(f);const{successful:t,queued:e,failed:i}=await r(n,f);u.event=f,u.status.ok=0===i.length,u.successful=t,u.queued=e,u.failed=i}return u};function d(t,o={}){if(i(o,{}))return t.config=n(t.config,{allowed:!0,count:0,globals:n(o,t.config.globalsStatic),timing:Date.now(),group:e()}),t.config.queue=[],Object.values(t.config.destinations).forEach((t=>{t.queue=[]})),t.config}var g=u;export{s as NodeClient,c as NodeDestination,u as createNodeClient,g as default,f as nodeClient};//# sourceMappingURL=index.mjs.map
"use strict";var t,n=Object.defineProperty,e=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,r={};((t,e)=>{for(var i in e)n(t,i,{get:e[i],enumerable:!0})})(r,{t:()=>g,i:()=>b,createNodeClient:()=>v,default:()=>p,nodeClient:()=>w}),module.exports=(t=r,((t,r,a,c)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let s of i(r))o.call(t,s)||s===a||n(t,s,{get:()=>r[s],enumerable:!(c=e(r,s))||c.enumerable});return t})(n({},"__esModule",{value:!0}),t));var a={o:"action",u:"config",l:"consent",g:"context",v:"destination",m:"elb",p:"globals",k:"hook",h:"init",j:"link",q:"data-elb",O:"run",C:"user",S:"walker"};function c(t,n={}){return Object.entries(n).forEach((([e,i])=>{let o=t[e];Array.isArray(o)&&Array.isArray(i)&&(n[e]=i.reduce(((t,n)=>t.includes(n)?t:[...t,n]),[...o]))})),{...t,...n}}function s(t=6){for(var n="";n.length<t;)n+=(36*Math.random()|0).toString(36);return n}function u(t,n){return typeof t==typeof n}function f(t,n){return async function(...e){try{return await t(...e)}catch(t){return n?await n(t):void 0}}}async function l(t,n,e){const i=e||t.config.destinations,o=t.config,r=await Promise.all(Object.entries(i).map((async([e,i])=>{let r;const a=[].concat(i.queue||[]);if(i.queue=[],n&&a.push(n),!a.length)return{id:e,destination:i,skipped:!0};if(!function(t,n){let e=!0;const i=n.config.consent;if(i){e=!1;const n=t.config.consent;Object.keys(i).forEach((t=>{n[t]&&(e=!0)}))}return e}(t,i))return{id:e,destination:i,queue:a};let s=a.map((t=>(t.consent=c(o.consent,t.consent),t.globals=c(o.globals,t.globals),t.user=c(o.user,t.user),{event:t})));if(i.init&&!i.config.init){const n=await f(i.init,(n=>{o.onError&&o.onError(n,t)}))(i.config)||!1;if(u(n,{})?i.config=n:i.config.init=n,!n)return{id:e,destination:i,queue:a}}return r=(await f(i.push,(n=>(o.onError&&o.onError(n,t),{error:n,queue:void 0})))(s,i.config)||{}).error,{id:e,destination:i,queue:[],error:r}}))),a=[],s=[],l=[];for(const t of r){if(t.skipped)continue;const n=t.id,e=t.destination;t.error?l.push({id:n,destination:e,error:String(t.error)}):t.queue&&t.queue.length?(e.queue=c(e.queue,t.queue),s.push({id:n,destination:e})):a.push({id:n,destination:e})}return{successful:a,queued:s,failed:l}}function d(t={},n={}){const e=n.globalsStatic||{},i={...{allowed:!1,client:"0.0.0",consent:{},custom:{},count:0,destinations:{},globals:{},globalsStatic:e,group:"",hooks:{},queue:[],round:0,timing:0,user:{},tagging:0,source:{type:"node",id:"",previous_id:""},verbose:!1},...n,...t},o=c(e,c(n.globals||{},t.globals||{}));return{...i,globals:o,globalsStatic:e,onLog:function(t,n){!function(t,n=!1){n&&console.dir(t,{depth:4})}({message:t},n||i.verbose)}}}var g={},b={};function v(t){const n=w(t);return{elb:n.push,instance:n}}function w(t={}){const n=d(t,{client:"2.0.0",globalsStatic:t.globals}),e={config:n,push:async(...t)=>{const i={status:{ok:!1},successful:[],queued:[],failed:[]};return await f(y,(t=>(n.onError&&n.onError(t,e),i.status.error=String(t),i)))(e,...t)}};return m(e),e}var y=async(t,n,e,i)=>{const o={status:{ok:!1},successful:[],queued:[],failed:[]};u(n,"")&&(n={event:n});const{event:r,action:c}=function(t,n={}){if(!n.event)throw new Error("Event name is required");const[e,i]=n.event.split(" ");if(!e||!i)throw new Error("Event name is invalid");if(e===a.S)return{action:i};const o=t.config;++o.count;const r=n.timestamp||Date.now(),c=n.timing||Math.round((r-(n.timing||o.timing))/10)/100,s=n.group||o.group,u=n.count||o.count,f=n.source||o.source;n.source&&(n.source.id&&(f.id=n.source.id),n.source.previous_id&&(f.previous_id=n.source.previous_id));const l={event:n.event,data:n.data||{},context:n.context||{},custom:n.custom||{},globals:n.globals||o.globals,user:n.user||o.user,nested:n.nested||[],consent:n.consent||o.consent,trigger:n.trigger||"",entity:e,action:i,timestamp:r,timing:c,group:s,count:u,id:`${r}-${s}-${u}`,version:{client:o.client,tagging:o.tagging},source:f};return{event:l}}(t,n);if(c){const n=await async function(t,n,e,i){let o,r={name:n,data:e};switch(n){case a.u:r.data=function(t,n={}){if(!u(n,{}))return;return t.config=d(n,t.config),t.config}(t,e)||{};break;case a.l:o=await async function(t,n={}){if(!u(n,{}))return;let e=!1;if(Object.entries(n).forEach((([n,i])=>{const o=!!i;t.config.consent[n]=o,e=e||o})),e)return await l(t)}(t,e);break;case a.v:o=await async function(t,n={},e={}){if(!u(n,{}))return;if(!u(e,{}))return;const i=e||n.config||{init:!1},o={init:n.init,push:n.push,config:i,type:n.type};let r=i.id;if(!r)do{r=s(4)}while(t.config.destinations[r]);return t.config.destinations[r]=o,!1!==i.queue&&(o.queue=[...t.config.queue]),await l(t,void 0,{[r]:o})}(t,e,i);break;case a.O:o=m(t,e);break;case a.C:r.data=function(t,n={}){if(!u(n,{}))return;const e={};"id"in n&&(e.id=n.id);"device"in n&&(e.device=n.device);"session"in n&&(e.session=n.session);return t.config.user=e,e}(t,e)}return{command:r,result:o}}(t,c,e,i);n.result&&u(n.result,{})&&(n.result.successful&&(o.successful=n.result.successful),n.result.queued&&(o.queued=n.result.queued),n.result.failed&&(o.failed=n.result.failed)),o.command=n.command,o.status.ok=!0}if(r){t.config.queue.push(r);const{successful:n,queued:e,failed:i}=await l(t,r);o.event=r,o.status.ok=0===i.length,o.successful=n,o.queued=e,o.failed=i}return o};function m(t,n={}){if(u(n,{}))return t.config=c(t.config,{allowed:!0,count:0,globals:c(n,t.config.globalsStatic),timing:Date.now(),group:s()}),t.config.queue=[],Object.values(t.config.destinations).forEach((t=>{t.queue=[]})),t.config}var p=v;//# sourceMappingURL=index.js.map
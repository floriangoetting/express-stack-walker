{"version":3,"sources":["../src/index.ts","../src/core/constants.ts","../src/core/assign.ts","../src/core/castValue.ts","../src/core/getByStringDot.ts","../src/core/getId.ts","../src/core/getMarketingParameters.ts","../src/core/invocations.ts","../src/core/isSameType.ts","../src/core/onLog.ts","../src/core/throwError.ts","../src/core/trim.ts","../src/core/tryCatch.ts","../src/core/useHooks.ts","../src/core/validate.ts","../src/web/getAttribute.ts","../src/web/isVisible.ts","../src/web/sessionStart.ts","../src/web/storage.ts"],"sourcesContent":["export * from './core';\nexport * from './web';\n","import type { Utils as TUtils, WalkerOS } from '@elbwalker/types';\n\nconst Commands: { [key: string]: WalkerOS.Commands } = {\n  Action: 'action',\n  Config: 'config',\n  Consent: 'consent',\n  Context: 'context',\n  Destination: 'destination',\n  Elb: 'elb',\n  Globals: 'globals',\n  Hook: 'hook',\n  Init: 'init',\n  Link: 'link',\n  Prefix: 'data-elb',\n  Run: 'run',\n  User: 'user',\n  Walker: 'walker',\n} as const;\n\nconst UtilsStorage: { [key: string]: TUtils.StorageType } = {\n  Cookie: 'cookie',\n  Local: 'local',\n  Session: 'session',\n} as const;\n\nconst Utils = {\n  Storage: UtilsStorage,\n};\n\nexport const Const = {\n  Commands,\n  Utils,\n};\n\nexport default Const;\n","export function assign<T>(target: T, source: Object = {}): T {\n  // Check for array properties to merge them before overriding\n  Object.entries(source).forEach(([key, sourceProp]) => {\n    const targetProp = target[key as keyof typeof target];\n\n    // Only merge arrays\n    if (Array.isArray(targetProp) && Array.isArray(sourceProp)) {\n      source[key as keyof typeof source] = sourceProp.reduce(\n        (acc, item) => {\n          // Remove duplicates\n          return acc.includes(item) ? acc : [...acc, item];\n        },\n        [...targetProp],\n      );\n    }\n  });\n\n  return { ...target, ...source };\n}\n","import { WalkerOS } from '@elbwalker/types';\n\nexport function castValue(value: unknown): WalkerOS.PropertyType {\n  if (value === 'true') return true;\n  if (value === 'false') return false;\n\n  const number = Number(value); // Converts \"\" to 0\n  if (value == number && value !== '') return number;\n\n  return String(value);\n}\n","export function getByStringDot(\n  event: unknown,\n  key: string,\n  i: unknown = 0,\n): unknown {\n  // String dot notation for object (\"data.id\" -> { data: { id: 1 } })\n  const value = key.split('.').reduce((obj, key) => {\n    // Update the wildcard to the given index\n    if (key == '*') key = String(i);\n\n    if (obj instanceof Object) return obj[key as keyof typeof obj];\n\n    return;\n  }, event);\n\n  return value;\n}\n","export function getId(length = 6): string {\n  for (var str = '', l = 36; str.length < length; )\n    str += ((Math.random() * l) | 0).toString(l);\n  return str;\n}\n","import { Utils, WalkerOS } from '@elbwalker/types';\n\nexport function getMarketingParameters(\n  url: URL,\n  custom: Utils.MarketingParameters = {},\n): WalkerOS.Properties {\n  const data: WalkerOS.Properties = {};\n  const parameters = Object.assign(\n    {\n      utm_campaign: 'campaign',\n      utm_content: 'content',\n      dclid: 'clickId',\n      fbclid: 'clickId',\n      gclid: 'clickId',\n      utm_medium: 'medium',\n      msclkid: 'clickId',\n      utm_source: 'source',\n      utm_term: 'term',\n    },\n    custom,\n  );\n\n  Object.entries(parameters).forEach(([param, name]) => {\n    const value = url.searchParams.get(param);\n    if (value) data[name] = value;\n  });\n\n  return data;\n}\n","export function debounce<P extends unknown[], R>(\n  fn: (...args: P) => R,\n  wait = 1000,\n) {\n  let timer: number | NodeJS.Timeout;\n\n  return (...args: P): Promise<R> => {\n    // abort previous invocation\n    clearTimeout(timer);\n\n    // Return value as promise\n    return new Promise((resolve) => {\n      // Schedule execution\n      timer = setTimeout(() => {\n        // Call the function\n        resolve(fn(...args));\n      }, wait);\n    });\n  };\n}\n\ntype Timeout = ReturnType<typeof setTimeout>;\nexport function throttle<P extends unknown[], R>(\n  fn: (...args: P) => R | undefined,\n  delay = 1000,\n): (...args: P) => R | undefined {\n  let isBlocked: Timeout | null = null;\n\n  return function (...args: P): R | undefined {\n    // Skip since function is still blocked by previous call\n    if (isBlocked !== null) return;\n\n    // Set a blocking timeout\n    isBlocked = setTimeout(() => {\n      // Unblock function\n      isBlocked = null;\n    }, delay) as Timeout;\n\n    // Call the function\n    return fn(...args);\n  };\n}\n","export function isSameType<T>(\n  variable: unknown,\n  type: T,\n): variable is typeof type {\n  return typeof variable === typeof type;\n}\n","export function onLog(message: unknown, verbose = false): void {\n  if (verbose) console.dir(message, { depth: 4 });\n}\n","export function throwError(error: unknown): never {\n  throw new Error(String(error));\n}\n","export function trim(str: string): string {\n  // Remove quotes and whitespaces\n  return str ? str.trim().replace(/^'|'$/g, '').trim() : '';\n}\n","// Use function overload to support different return type depending on onError\n// Types\nexport function tryCatch<P extends unknown[], R, S>(\n  fn: (...args: P) => R | undefined,\n  onError: (err: unknown) => S,\n): (...args: P) => R | S;\nexport function tryCatch<P extends unknown[], R>(\n  fn: (...args: P) => R | undefined,\n): (...args: P) => R | undefined;\n// Implementation\nexport function tryCatch<P extends unknown[], R, S>(\n  fn: (...args: P) => R | undefined,\n  onError?: (err: unknown) => S,\n): (...args: P) => R | S | undefined {\n  return function (...args: P): R | S | undefined {\n    try {\n      return fn(...args);\n    } catch (err) {\n      if (!onError) return;\n      return onError(err);\n    }\n  };\n}\n\n// Use function overload to support different return type depending on onError\n// Types\nexport function tryCatchAsync<P extends unknown[], R, S>(\n  fn: (...args: P) => R,\n  onError: (err: unknown) => S,\n): (...args: P) => Promise<R | S>;\nexport function tryCatchAsync<P extends unknown[], R>(\n  fn: (...args: P) => R,\n): (...args: P) => Promise<R | undefined>;\n// Implementation\nexport function tryCatchAsync<P extends unknown[], R, S>(\n  fn: (...args: P) => R,\n  onError?: (err: unknown) => S,\n): (...args: P) => Promise<R | S | undefined> {\n  return async function (...args: P): Promise<R | S | undefined> {\n    try {\n      return await fn(...args);\n    } catch (err) {\n      if (!onError) return;\n      return await onError(err);\n    }\n  };\n}\n","import { Hooks } from '@elbwalker/types';\n\nexport function useHooks<P extends any[], R>(\n  fn: (...args: P) => R,\n  name: string,\n  hooks: Hooks.Functions,\n): (...args: P) => R {\n  return function (...args: P): R {\n    let result: R;\n    const preHook = ('pre' + name) as keyof Hooks.Functions;\n    const postHook = ('post' + name) as keyof Hooks.Functions;\n    const preHookFn = hooks[preHook] as unknown as Hooks.HookFn<typeof fn>;\n    const postHookFn = hooks[postHook] as unknown as Hooks.HookFn<typeof fn>;\n\n    if (preHookFn) {\n      // Call the original function within the preHook\n      result = preHookFn({ fn }, ...args);\n    } else {\n      // Regular function call\n      result = fn(...args);\n    }\n\n    if (postHookFn) {\n      // Call the post-hook function with fn, result, and the original args\n      result = postHookFn({ fn, result }, ...args);\n    }\n\n    return result;\n  };\n}\n","import { Schema, WalkerOS } from '@elbwalker/types';\nimport { throwError } from './throwError';\nimport { isSameType } from './isSameType';\nimport { tryCatch } from './tryCatch';\n\nexport function validateEvent(\n  obj: unknown,\n  customContracts: Schema.Contracts = [],\n): WalkerOS.Event | never {\n  if (!isSameType(obj, {} as WalkerOS.AnyObject)) throwError('Invalid object');\n\n  let event: string;\n  let entity: string;\n  let action: string;\n\n  // Check if event.event is available and it's a string\n  if (isSameType(obj.event, '')) {\n    event = obj.event;\n    [entity, action] = event.split(' ');\n    if (!entity || !action) throwError('Invalid event name');\n  } else if (isSameType(obj.entity, '') && isSameType(obj.action, '')) {\n    entity = obj.entity;\n    action = obj.action;\n    event = `${entity} ${action}`;\n  } else {\n    throwError('Missing or invalid event, entity, or action');\n  }\n\n  const basicContract: Schema.Contract = {\n    '*': {\n      '*': {\n        event: { maxLength: 255 }, // @TODO as general rule?\n        user: { allowedKeys: ['id', 'device', 'session'] },\n        consent: { allowedValues: [true, false] },\n        timestamp: { min: 0 },\n        timing: { min: 0 },\n        count: { min: 0 },\n        version: { allowedKeys: ['client', 'tagging'] },\n        source: { allowedKeys: ['type', 'id', 'previous_id'] },\n      },\n    },\n  };\n\n  const basicEvent: WalkerOS.Event = {\n    event,\n    data: {},\n    context: {},\n    custom: {},\n    globals: {},\n    user: {},\n    nested: [],\n    consent: {},\n    id: '',\n    trigger: '',\n    entity,\n    action,\n    timestamp: 0,\n    timing: 0,\n    group: '',\n    count: 0,\n    version: { client: '', tagging: 0 },\n    source: { type: '', id: '', previous_id: '' },\n  };\n\n  // Collect all relevant schemas for the event\n  const schemas = [basicContract]\n    .concat(customContracts)\n    .reduce((acc, contract) => {\n      return ['*', entity].reduce((entityAcc, e) => {\n        return ['*', action].reduce((actionAcc, a) => {\n          const schema = contract[e]?.[a];\n          return schema ? actionAcc.concat([schema]) : actionAcc;\n        }, entityAcc);\n      }, acc);\n    }, [] as Schema.Properties[]);\n\n  const result = schemas.reduce(\n    (acc, schema) => {\n      // Get all required properties\n      const requiredKeys = Object.keys(schema).filter((key) => {\n        const property = schema[key];\n        return property?.required === true;\n      });\n\n      // Validate both, ingested and required properties but only once\n      return [...Object.keys(obj), ...requiredKeys].reduce((acc, key) => {\n        const propertySchema = schema[key];\n        let value = obj[key];\n\n        if (propertySchema) {\n          // Update the value\n          value = tryCatch(validateProperty, (err) => {\n            throwError(String(err));\n          })(acc, key, value, propertySchema);\n        }\n\n        // Same type check\n        if (isSameType(value, acc[key])) acc[key] = value;\n\n        return acc;\n      }, acc);\n    },\n    // Not that beautiful but it works, narrowing down the type is tricky here\n    // it's important that basicEvent is defined as an WalkerOS.Event\n    basicEvent as unknown as WalkerOS.AnyObject,\n  ) as unknown as WalkerOS.Event;\n\n  // @TODO Final check for result.event === event.entity + ' ' + event.action\n\n  return result;\n}\n\nexport function validateProperty(\n  obj: WalkerOS.AnyObject,\n  key: string,\n  value: unknown,\n  schema: Schema.Property,\n): WalkerOS.Property | never {\n  // @TODO unknown to WalkerOS.Property\n\n  // Note regarding potentially malicious values\n  // Initial collection doesn't manipulate data\n  // Prefer context-specific checks in the destinations\n\n  // Custom validate function can change the value\n  if (schema.validate)\n    value = tryCatch(schema.validate, (err) => {\n      throwError(String(err));\n    })(value, key, obj);\n\n  if (schema.required && value === undefined)\n    throwError('Missing required property');\n\n  // Strings\n  if (isSameType(value, '' as string)) {\n    if (schema.maxLength && value.length > schema.maxLength) {\n      if (schema.strict) throwError('Value exceeds maxLength');\n      value = value.substring(0, schema.maxLength);\n    }\n  }\n\n  // Numbers\n  else if (isSameType(value, 1 as number)) {\n    if (isSameType(schema.min, 1) && value < schema.min) {\n      if (schema.strict) throwError('Value below min');\n      value = schema.min;\n    } else if (isSameType(schema.max, 1) && value > schema.max) {\n      if (schema.strict) throwError('Value exceeds max');\n      value = schema.max;\n    }\n  }\n\n  // @TODO boolean\n\n  // Objects\n  else if (isSameType(value, {} as WalkerOS.AnyObject)) {\n    if (schema.schema) {\n      const nestedSchema = schema.schema;\n\n      // @TODO handle return to update value as non unknown\n      // @TODO bug with multiple rules in property schema\n      Object.keys(nestedSchema).reduce((acc, key) => {\n        const propertySchema = nestedSchema[key];\n        let value = acc[key];\n\n        if (propertySchema) {\n          // Type check\n          if (propertySchema.type && typeof value !== propertySchema.type)\n            throwError(`Type doesn't match (${key})`);\n\n          // Update the value\n          value = tryCatch(validateProperty, (err) => {\n            throwError(String(err));\n          })(acc, key, value, propertySchema);\n        }\n\n        return value as WalkerOS.AnyObject;\n      }, value);\n    }\n\n    for (const [objKey, objValue] of Object.entries(value)) {\n      // Check for allowed keys if applicable\n      if (schema.allowedKeys && !schema.allowedKeys.includes(objKey)) {\n        if (schema.strict) throwError('Key not allowed');\n\n        delete value[objKey];\n      }\n    }\n  }\n\n  return value as WalkerOS.Property;\n}\n","// @TODO add trim\nexport function getAttribute(element: Element, name: string): string {\n  return element.getAttribute(name) || '';\n}\n","export function isVisible(element: HTMLElement): boolean {\n  // Check for hiding styles\n  const style = getComputedStyle(element);\n  if (style.display === 'none') return false;\n  if (style.visibility !== 'visible') return false;\n  if (style.opacity && Number(style.opacity) < 0.1) return false;\n\n  // Window positions\n  let pointContainer;\n  const windowHeight = window.innerHeight; // Height of the viewport\n\n  // Element positions\n  const elemRectRel = element.getBoundingClientRect(); // Get the elements relative to the viewport\n  const elementHeight = elemRectRel.height; // Height of the element\n  const elementTopRel = elemRectRel.y; // Relative distance from window top to element top\n  const elementBottomRel = elementTopRel + elementHeight; // Relative distance from window to to element bottom\n  const elemCenterRel = {\n    // Relative position on viewport of the elements center\n    x: elemRectRel.x + element.offsetWidth / 2,\n    y: elemRectRel.y + element.offsetHeight / 2,\n  };\n\n  // Differentiate between small and large elements\n  if (elementHeight <= windowHeight) {\n    // Smaller than the viewport\n\n    // Must have a width and height\n    if (\n      element.offsetWidth + elemRectRel.width === 0 ||\n      element.offsetHeight + elemRectRel.height === 0\n    )\n      return false;\n\n    if (elemCenterRel.x < 0) return false;\n    if (\n      elemCenterRel.x >\n      (document.documentElement.clientWidth || window.innerWidth)\n    )\n      return false;\n    if (elemCenterRel.y < 0) return false;\n    if (\n      elemCenterRel.y >\n      (document.documentElement.clientHeight || window.innerHeight)\n    )\n      return false;\n\n    // Select the element that is at the center of the target\n    pointContainer = document.elementFromPoint(\n      elemCenterRel.x,\n      elemCenterRel.y,\n    );\n  } else {\n    // Bigger than the viewport\n\n    // that are considered visible if they fill half of the screen\n    const viewportCenter = windowHeight / 2;\n\n    // Check if upper part is above the viewports center\n    if (elementTopRel < 0 && elementBottomRel < viewportCenter) return false;\n\n    // Check if lower part is below the viewports center\n    if (elementBottomRel > windowHeight && elementTopRel > viewportCenter)\n      return false;\n\n    // Select the element that is in the middle of the screen\n    pointContainer = document.elementFromPoint(\n      elemCenterRel.x,\n      windowHeight / 2,\n    );\n  }\n\n  // Check for potential overlays\n  if (pointContainer) {\n    do {\n      if (pointContainer === element) return true; // should be visible\n    } while ((pointContainer = pointContainer.parentElement));\n  }\n\n  return false;\n}\n","import { Utils, WalkerOS } from '@elbwalker/types';\nimport { getId, getMarketingParameters } from '..';\n\nexport function sessionStart(\n  config: Utils.SessionStart = {},\n): WalkerOS.Properties | false {\n  // Force a new session or start checking if it's a regular new one\n  let isNew = config.isNew || false;\n\n  // Entry type\n  if (!isNew) {\n    // Only focus on linked or direct navigation types\n    // and ignore reloads and all others\n    const [perf] = performance.getEntriesByType(\n      'navigation',\n    ) as PerformanceNavigationTiming[];\n    if (perf.type !== 'navigate') return false;\n  }\n\n  const url = new URL(config.url || window.location.href);\n  const ref = config.referrer || document.referrer;\n  const referrer = ref && new URL(ref).hostname;\n  const session: WalkerOS.Properties = {};\n\n  // Marketing\n  const marketing = getMarketingParameters(url, config.parameters);\n  if (Object.keys(marketing).length) {\n    // Check for marketing parameters like UTM and add existing\n    session.marketing = true; // Flag as a marketing session\n    isNew = true;\n  }\n\n  // Referrer\n  if (!isNew) {\n    // Small chance of multiple unintendet events for same users\n    // https://en.wikipedia.org/wiki/HTTP_referer#Referrer_hiding\n    // Use domains: [''] to disable direct or hidden referrer\n\n    const domains = config.domains || [];\n    domains.push(url.hostname);\n    isNew = !domains.includes(referrer);\n  }\n\n  // No new session\n  if (!isNew) return false;\n\n  if (referrer) session.referrer = referrer;\n  Object.assign(\n    session,\n    {\n      id: session.id || getId(12),\n    },\n    marketing,\n    config.data,\n  );\n\n  // It's a new session, moin\n  return session;\n}\n","import { Utils, WalkerOS } from '@elbwalker/types';\nimport { Const, castValue } from '..';\n\nexport function storageDelete(\n  key: string,\n  storage: Utils.StorageType = Const.Utils.Storage.Session,\n) {\n  switch (storage) {\n    case Const.Utils.Storage.Cookie:\n      storageWrite(key, '', 0, storage);\n      break;\n    case Const.Utils.Storage.Local:\n      window.localStorage.removeItem(key);\n      break;\n    case Const.Utils.Storage.Session:\n      window.sessionStorage.removeItem(key);\n      break;\n  }\n}\n\nexport function storageRead(\n  key: string,\n  storage: Utils.StorageType = Const.Utils.Storage.Session,\n): WalkerOS.PropertyType {\n  // Helper function for local and session storage to support expiration\n  function parseItem(string: string | null): Utils.StorageValue {\n    try {\n      return JSON.parse(string || '');\n    } catch (err) {\n      let e = 1,\n        v = '';\n\n      // Remove expiration date\n      if (string) {\n        e = 0;\n        v = string;\n      }\n\n      return { e, v };\n    }\n  }\n  let value, item;\n\n  switch (storage) {\n    case Const.Utils.Storage.Cookie:\n      value = decodeURIComponent(\n        document.cookie\n          .split('; ')\n          .find((row) => row.startsWith(key + '='))\n          ?.split('=')[1] || '',\n      );\n      break;\n    case Const.Utils.Storage.Local:\n      item = parseItem(window.localStorage.getItem(key));\n      break;\n    case Const.Utils.Storage.Session:\n      item = parseItem(window.sessionStorage.getItem(key));\n      break;\n  }\n\n  // Check if item is expired\n  if (item) {\n    value = item.v;\n\n    if (item.e != 0 && item.e < Date.now()) {\n      storageDelete(key, storage); // Remove item\n      value = ''; // Conceal the outdated value\n    }\n  }\n\n  return castValue(value || '');\n}\n\nexport function storageWrite(\n  key: string,\n  value: WalkerOS.PropertyType,\n  maxAgeInMinutes = 30,\n  storage: Utils.StorageType = Const.Utils.Storage.Session,\n  domain?: string,\n): WalkerOS.PropertyType {\n  const e = Date.now() + 1000 * 60 * maxAgeInMinutes;\n  const item: Utils.StorageValue = { e, v: String(value) };\n  const stringifiedItem = JSON.stringify(item);\n\n  switch (storage) {\n    case Const.Utils.Storage.Cookie:\n      let cookie = `${key}=${encodeURIComponent(value)}; max-age=${\n        maxAgeInMinutes * 60\n      }; path=/; SameSite=Lax; secure`;\n\n      if (domain) cookie += '; domain=' + domain;\n\n      document.cookie = cookie;\n      break;\n    case Const.Utils.Storage.Local:\n      window.localStorage.setItem(key, stringifiedItem);\n      break;\n    case Const.Utils.Storage.Session:\n      window.sessionStorage.setItem(key, stringifiedItem);\n      break;\n  }\n\n  return storageRead(key, storage);\n}\n"],"mappings":"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","names":["src_exports","__export","Const","assign","castValue","debounce","getAttribute","getByStringDot","getId","getMarketingParameters","isSameType","isVisible","onLog","sessionStart","storageDelete","storageRead","storageWrite","throttle","throwError","trim","tryCatch","tryCatchAsync","useHooks","validateEvent","validateProperty","__toCommonJS","Commands","UtilsStorage","Utils","Const","assign","target","source","key","sourceProp","targetProp","acc","item","castValue","value","number","getByStringDot","event","key","i","obj","getId","length","str","l","getMarketingParameters","url","custom","data","parameters","param","name","value","debounce","fn","wait","timer","args","resolve","throttle","delay","isBlocked","isSameType","variable","type","onLog","message","verbose","throwError","error","trim","str","tryCatch","fn","onError","args","err","tryCatchAsync","useHooks","fn","name","hooks","args","result","preHook","postHook","preHookFn","postHookFn","validateEvent","obj","customContracts","isSameType","throwError","event","entity","action","basicContract","basicEvent","acc","contract","entityAcc","e","actionAcc","a","_a","schema","requiredKeys","key","property","propertySchema","value","tryCatch","validateProperty","err","nestedSchema","objKey","objValue","getAttribute","element","name","isVisible","element","style","pointContainer","windowHeight","elemRectRel","elementHeight","elementTopRel","elementBottomRel","elemCenterRel","viewportCenter","sessionStart","config","isNew","perf","url","ref","referrer","session","marketing","getMarketingParameters","domains","getId","storageDelete","key","storage","Const","storageWrite","storageRead","_a","parseItem","string","err","e","v","value","item","row","castValue","maxAgeInMinutes","domain","stringifiedItem","cookie"]}